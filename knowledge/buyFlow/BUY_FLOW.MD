NEYXT ‚Äì Buy Flow (Polygon)

A minimal-friction way for users to buy NEYXT on Polygon using USDC/POL/ETH or Fiat, while paying gas in NEYXT via a token paymaster (no native POL/MATIC required).

Principles
	‚Ä¢	Ship fast with existing infra: Supabase Edge Functions + Vercel
	‚Ä¢	Keep front & back in one repo
	‚Ä¢	No native gas UX (fees charged in NEYXT)
	‚Ä¢	Safe quotes (price bounds vs WETH/NEYXT reference pool)

‚∏ª

1) High-level UX
	‚Ä¢	Single CTA: Buy NEYXT
	‚Ä¢	3 steps: Select pay asset ‚Üí Get quote ‚Üí Confirm
	‚Ä¢	Crypto path (Polygon): (USDC | POL | ETH) ‚Üí swap ‚Üí NEYXT
	‚Ä¢	Fiat path: Onramp ‚Üí settle USDC/POL on Polygon ‚Üí auto-swap ‚Üí NEYXT
	‚Ä¢	Gas abstraction: Biconomy Token Paymaster charges fees in NEYXT
	‚Ä¢	Fail-fast copy if insufficient NEYXT to cover fees (suggest increase amount)

‚∏ª

2) Current Stack
	‚Ä¢	Frontend: React + Vite + Tailwind (Vercel)
	‚Ä¢	Wallet/Auth: Web3Auth (LinkedIn-only)
	‚Ä¢	Backend: Supabase Edge Functions (Deno)
	‚Ä¢	Web3: Polygon, ethers v6
	‚Ä¢	Providers:
	‚Ä¢	Onramp: Transak (Ramp Network as backup)
	‚Ä¢	Swap Aggregator: 0x Swap API (ParaSwap or LI.FI single-chain as backup)
	‚Ä¢	Gas Abstraction: Biconomy Token Paymaster (Gelato backup)

‚∏ª

3) Repo Placement (Added/Updated files)

See the merged tree in context. Key additions:
	‚Ä¢	Frontend
	‚Ä¢	src/components/wallet/BuyNeyxtModal.tsx  (TODO [M6.1])
	‚Ä¢	src/components/wallet/OnrampWidget.tsx  (TODO [M7.1])
	‚Ä¢	src/components/wallet/GaslessBadge.tsx   (TODO [M6.3])
	‚Ä¢	src/components/ui/QuoteBreakdown.tsx     (TODO [M4.4])
	‚Ä¢	src/hooks/useQuote.ts                    (TODO [M4.2])
	‚Ä¢	src/hooks/useBuyNeyxt.ts                 (TODO [M5.5])
	‚Ä¢	src/hooks/useOnrampEvents.ts             (TODO [M7.3])
	‚Ä¢	src/services/swapService.ts              (TODO [M4.2])
	‚Ä¢	src/services/paymasterService.ts         (TODO [M5.4])
	‚Ä¢	src/services/onrampService.ts            (TODO [M7.4])
	‚Ä¢	src/services/analytics.ts                (TODO [M6.4])
	‚Ä¢	src/config/contracts.ts                  (TODO [M1.1/M2.2/M3.1])
	‚Ä¢	src/config/env.ts                        (TODO [M1.2])
	‚Ä¢	src/config/networks.ts                   (TODO [M1.3])
	‚Ä¢	src/types/buy.ts                         (TODO [M4.3])
	‚Ä¢	Edge Functions
	‚Ä¢	supabase/functions/quote/                (GET /api/quote ‚Äì TODO [M4.1])
	‚Ä¢	supabase/functions/execute/              (POST /api/execute ‚Äì TODO [M5.2])
	‚Ä¢	supabase/functions/status/               (GET /api/status ‚Äì TODO [M5.3])
	‚Ä¢	supabase/functions/onramp-webhook/       (Onramp ‚Üí autoswap ‚Äì TODO [M7.2])
	‚Ä¢	supabase/functions/_shared/pricing.ts    (pool TWAP & sanity ‚Äì TODO [M3.2])
	‚Ä¢	supabase/functions/_shared/paymaster.ts  (token paymaster utils ‚Äì TODO [M5.1])
	‚Ä¢	supabase/functions/_shared/hmac.ts       (webhook verify ‚Äì TODO [M7.2])

‚∏ª

4) Feature Flags

Set in frontend via src/config/env.ts (public), toggled per env:
	‚Ä¢	NEXT_PUBLIC_FEATURE_ENABLE_FIAT (bool)
	‚Ä¢	NEXT_PUBLIC_FEATURE_ENABLE_GAS_SPONSORSHIP (bool)
	‚Ä¢	NEXT_PUBLIC_FEATURE_ENABLE_CROSS_CHAIN (bool; phase 2+)

‚∏ª

5) Environment Variables

Public (frontend)

Safe to expose in client (build-time or runtime via Vercel env):

	‚Ä¢	NEXT_PUBLIC_CHAIN_ID ‚Äì Polygon chain ID
	‚Ä¢	NEXT_PUBLIC_NEYXT_ADDRESS ‚Äì NEYXT ERC-20 address on Polygon
	‚Ä¢	NEXT_PUBLIC_FEATURE_ENABLE_FIAT ‚Äì true|false
	‚Ä¢	NEXT_PUBLIC_FEATURE_ENABLE_GAS_SPONSORSHIP ‚Äì true|false
	‚Ä¢	NEXT_PUBLIC_FEATURE_ENABLE_CROSS_CHAIN ‚Äì true|false

Server (Supabase Edge Functions ‚Äì store as secrets)

Never expose to frontend:

	‚Ä¢	ZEROX_API_KEY ‚Äì 0x Swap API key
	‚Ä¢	ONRAMP_API_KEY ‚Äì Transak (or Ramp) API key
	‚Ä¢	ONRAMP_WEBHOOK_SECRET ‚Äì HMAC secret to verify onramp events
	‚Ä¢	BICONOMY_API_KEY ‚Äì Biconomy
	‚Ä¢	BICONOMY_PAYMASTER_ID ‚Äì Token paymaster app/ID
	‚Ä¢	ALCHEMY_OR_RPC_URL_POLYGON ‚Äì RPC for Polygon
	‚Ä¢	REF_POOL_ADDRESS ‚Äì WETH/NEYXT reference pool address (DEX specific)
	‚Ä¢	ALLOWED_ROUTERS ‚Äì Comma-separated router addresses allowlist (e.g., 0x, ParaSwap)

Optional / later:
	‚Ä¢	SENTRY_DSN, LOG_LEVEL, RATE_LIMIT_CFG, COMPLIANCE_GEOFENCE

‚∏ª

6) API Contracts (Edge)

GET /api/quote  (TODO [M4.1])

Query

pay_asset=USDC|POL|ETH|FIAT
pay_chain=polygon   // v1 polygon-only; ‚ÄúFIAT‚Äù returns onramp params
amount_in=string_decimal
receive_asset=NEYXT
receive_chain=polygon

Response

{
  "route_id": "string",
  "amount_out_est": "string_decimal",
  "price": "string_decimal",
  "fees": {
    "protocol": "string_decimal",
    "gas_in_neyxt_est": "string_decimal"
  },
  "slippage_bps": 100,
  "estimated_time_sec": 0,
  "ttl_sec": 45,
  "warnings": ["string"]
}

POST /api/execute  (TODO [M5.2])

Body

{
  "route_id": "string",
  "user_address": "0x...",
  "sponsor_gas": true
}

Response

{
  "tx_ids": ["0x..."],
  "status_url": "/api/status?route_id=string"
}

GET /api/status  (TODO [M5.3])

Query

route_id=string

Response

{
  "state": "PENDING|CONFIRMED|FAILED",
  "tx_ids": ["0x..."],
  "details": "string"
}

POST /api/onramp-webhook  (TODO [M7.2])
	‚Ä¢	Verify HMAC (ONRAMP_WEBHOOK_SECRET)
	‚Ä¢	On success: server-initiated autoswap USDC‚ÜíNEYXT via /api/execute
	‚Ä¢	Must be idempotent (no double swaps on retries)

‚∏ª

7) Pricing Guardrails (Reference Pool)
	‚Ä¢	Reference: QuickSwap v2 WETH/NEYXT 50/50 pool on Polygon (REF_POOL_ADDRESS)
	‚Ä¢	Policy:
	‚Ä¢	slippage_bps ‚â§ 100
	‚Ä¢	max_price_impact_bps ‚â§ 200
	‚Ä¢	quote_ttl_sec = 45
	‚Ä¢	min_purchase_multiple_of_gas ‚â• 1.25
	‚Ä¢	max_trade_notional_base = CAP_IN_WETH
	‚Ä¢	per_wallet_daily_cap_base = CAP_PER_WALLET
	‚Ä¢	Reject quotes if route price deviates from pool TWAP beyond policy thresholds

‚∏ª

8) Telemetry (Events & Targets)

Events
	‚Ä¢	buy_opened, asset_selected, quote_returned, kyc_started
	‚Ä¢	swap_submitted, swap_confirmed, swap_failed
	‚Ä¢	time_to_complete_sec

Targets
	‚Ä¢	Success rate ‚â• 95%
	‚Ä¢	Median time to complete ‚â§ 180s
	‚Ä¢	Drop-off before payment ‚â§ 15%

‚∏ª

9) Milestones & Checklists

Legend:
‚úÖ = done‚ÄÉüß© = in progress‚ÄÉ‚¨ú = todo

M1 ‚Äì Foundation
	‚Ä¢	‚¨ú M1.1 Create contracts.ts (placeholders) & README-BUY-FLOW.md
	‚Ä¢	‚¨ú M1.2 Extend env.ts with feature flags & API base
	‚Ä¢	‚¨ú M1.3 Ensure networks.ts has Polygon mainnet + Amoy
	‚Ä¢	‚¨ú M1.4 Edge ‚Äúhealth‚Äù routes deployable

Exit: Frontend builds; Edge deploy OK.

‚∏ª

M2 ‚Äì Providers & Addresses
	‚Ä¢	‚¨ú Transak account; Polygon USDC/POL enabled
	‚Ä¢	‚¨ú 0x API key; Polygon enabled
	‚Ä¢	‚¨ú Biconomy paymaster app created; NEYXT allowed as fee token
	‚Ä¢	‚¨ú Fill contracts.ts: NEYXT, WETH, routers, REF_POOL_ADDRESS
	‚Ä¢	‚¨ú Save secrets in Supabase (DEV/PROD)

M2.3 ‚Äì Pool Creation
	‚Ä¢	‚¨ú Choose initial NEYXT price (low, conservative) and compute seed amounts
	‚Ä¢	‚¨ú Create QuickSwap v2 WETH/NEYXT pool (50/50)
	‚Ä¢	‚¨ú Record pool/router/factory addresses in contracts.ts and ALLOWED_ROUTERS
	‚Ä¢	‚¨ú Set REF_POOL_ADDRESS secret and verify quotes via 0x

Exit: Keys present; paymaster NEYXT-configured.

‚∏ª

M3 ‚Äì Reference Pool & Pricing
	‚Ä¢	‚¨ú Confirm WETH/NEYXT pool DEX + address
	‚Ä¢	‚¨ú _shared/pricing.ts: spot/TWAP fetch utility
	‚Ä¢	‚¨ú Sanity checks (deviation, slippage, TTL) + unit tests

Exit: Quotes rejected when out of bounds.

‚∏ª

M4 ‚Äì Quote Endpoint
	‚Ä¢	‚¨ú GET /api/quote with 0x (Polygon-only v1)
	‚Ä¢	‚¨ú swapService.ts + useQuote.ts in FE
	‚Ä¢	‚¨ú QuoteBreakdown.tsx UI
	‚Ä¢	‚¨ú Return gas_in_neyxt_est and warnings for min purchase
	‚Ä¢	‚¨ú Enforce min purchase (NEYXT_out ‚â• 1.25√ó gas_in_neyxt_est)
	‚Ä¢	‚¨ú Apply per-trade cap (‚â§ max_trade_notional_base)

Exit: Valid quotes for USDC/POL/ETH.

‚∏ª

M5 ‚Äì Execute & Status (Gas in NEYXT)
	‚Ä¢	‚¨ú _shared/paymaster.ts (Biconomy Token Paymaster)
	‚Ä¢	‚¨ú POST /api/execute uses paymaster; no native POL required
	‚Ä¢	‚¨ú GET /api/status (poll tx/route)
	‚Ä¢	‚¨ú useBuyNeyxt.ts orchestration
	‚Ä¢	‚¨ú Fail-fast if NEYXT_out < gas_in_neyxt_est + buffer
	‚Ä¢	‚¨ú Apply per-wallet daily cap during execution

Exit: Swap executes gasless (for user); clear insufficient NEYXT message.

‚∏ª

M6 ‚Äì Frontend Modal UX
	‚Ä¢	‚¨ú Add CTA in HomePage.tsx
	‚Ä¢	‚¨ú BuyNeyxtModal.tsx (3 steps)
	‚Ä¢	‚¨ú GaslessBadge.tsx
	‚Ä¢	‚¨ú analytics.ts events

Exit: 3-step flow functional on DEV.

‚∏ª

M7 ‚Äì Fiat Onramp & Autoswap
	‚Ä¢	‚¨ú OnrampWidget.tsx (prefill wallet + Polygon)
	‚Ä¢	‚¨ú onramp-webhook (HMAC verify, idempotent)
	‚Ä¢	‚¨ú Autoswap to NEYXT via server /api/execute
	‚Ä¢	‚¨ú useOnrampEvents.ts status handling

Exit: Fiat ‚Üí NEYXT path confirmed on DEV.

‚∏ª

M8 ‚Äì Observability
	‚Ä¢	‚¨ú route_id correlation across quote/execute/status
	‚Ä¢	‚¨ú Counters: success_rate, median_time_to_complete, drop-off
	‚Ä¢	‚¨ú Alerts on provider errors (0x, paymaster, onramp)

Exit: Minimal dashboard covers funnel; alerts wired.

‚∏ª

M9 ‚Äì Staging/Prod & Launch
	‚Ä¢	‚¨ú Feature flags: enable internally, then public
	‚Ä¢	‚¨ú Scripted test purchases (USDC‚ÜíNEYXT, POL‚ÜíNEYXT, Fiat‚ÜíNEYXT)
	‚Ä¢	‚¨ú Go-live: public flags on; support runbook ready

Exit: Users complete purchases in ‚â§ 3 steps; metrics on target.

‚∏ª

10) Runbooks (Short)

Onramp down
	‚Ä¢	Action: Disable NEXT_PUBLIC_FEATURE_ENABLE_FIAT; show copy recommending crypto path.

DEX liquidity thin / price impact high
	‚Ä¢	Action: Raise min purchase or fallback to backup aggregator; show ‚Äútry smaller amount‚Äù copy.

Paymaster errors / Insufficient NEYXT for fees
	‚Ä¢	Action: Bump min NEYXT_out threshold; show copy ‚ÄúIncrease amount to cover fees.‚Äù

RPC degraded
	‚Ä¢	Action: Switch to backup RPC; degrade to slower polling; surface status to user.

‚∏ª

11) Security & Compliance
	‚Ä¢	Never custody user funds.
	‚Ä¢	Verify & pin contract addresses and chain IDs.
	‚Ä¢	Only call allowlisted routers/bridges.
	‚Ä¢	Use HMAC on onramp webhook; ensure idempotency.
	‚Ä¢	Reasonable rate limits and per-user caps.
	‚Ä¢	KYC/AML handled by the onramp; store status/refs only (no PII duplication).

‚∏ª

12) Acceptance Criteria
	‚Ä¢	‚â§ 3 steps to buy
	‚Ä¢	No native gas needed (fees in NEYXT)
	‚Ä¢	Fiat & crypto both deliver NEYXT to the same wallet
	‚Ä¢	Clear failure when NEYXT insufficient to cover fees
	‚Ä¢	Metrics hit: success ‚â• 95%, median time ‚â§ 180s

‚∏ª

13) Decision Log (living)
	‚Ä¢	Backend: Supabase Edge Functions (keep single-repo DX).
	‚Ä¢	Onramp: Transak primary (Ramp backup).
	‚Ä¢	Swap: 0x primary (ParaSwap/LI.FI single-chain backup).
	‚Ä¢	Gas: Biconomy Token Paymaster (Gelato backup).
	‚Ä¢	Scope v1: Polygon-only (USDC/POL/ETH + Fiat). Cross-chain later.

‚∏ª

Owner: Stephane
Last updated: [fill date]
Next action: Start M1 checklist and seed ENV for DEV.